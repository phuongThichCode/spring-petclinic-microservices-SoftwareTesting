name: CI Pipeline

on:
  push:
    branches: ["main", "develop", "feature/**"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  actions: read
  checks: write

env:
  JAVA_VERSION: "17"
  MIN_COVERAGE: "70"

jobs:
  detect-changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changed microservices
        id: detect
        run: |
          git fetch origin main || true
          CHANGED=$(git diff --name-only origin/main...HEAD | grep -E '^(customers-service|vets-service|visit-service|api-gateway|admin-server|discovery-server|config-server)/' | cut -d'/' -f1 | sort -u | xargs)
          echo "Changed services: $CHANGED"
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT

  test:
    name: Unit Test & Coverage
    needs: detect-changes
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Run tests
        run: |
          if [ -z "${{ needs.detect-changes.outputs.changed }}" ]; then
            echo "No changed services — running all tests."
            mvn -B clean test
          else
            for s in ${{ needs.detect-changes.outputs.changed }}; do
              echo "Testing $s ..."
              cd $s
              mvn -B clean test
              cd ..
            done
          fi

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-reports
          path: '**/target/surefire-reports/*.xml'

      - name: Upload JaCoCo reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: '**/target/site/jacoco/jacoco.xml'

  coverage-check:
    name: Verify coverage threshold
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: jacoco-reports
          path: ./reports

      - name: Calculate coverage and validate
        env:
          MIN_COVERAGE: ${{ env.MIN_COVERAGE }}
        run: |
          total_missed=0
          total_covered=0
          for file in $(find ./reports -name "jacoco.xml" || true); do
            while read -r line; do
              missed=$(echo "$line" | grep -oP 'missed="\K[0-9]+' || echo 0)
              covered=$(echo "$line" | grep -oP 'covered="\K[0-9]+' || echo 0)
              total_missed=$((total_missed + missed))
              total_covered=$((total_covered + covered))
            done < <(grep '<counter type="INSTRUCTION"' "$file" || true)
          done
          if [ "$total_covered" -eq 0 ] && [ "$total_missed" -eq 0 ]; then
            echo "No coverage data found."
            exit 1
          fi
          coverage=$(awk -v c=$total_covered -v m=$total_missed 'BEGIN {printf "%.2f", c*100/(c+m)}')
          echo "Coverage: $coverage%"
          if (( $(echo "$coverage < $MIN_COVERAGE" | bc -l) )); then
            echo "Coverage below $MIN_COVERAGE%"
            exit 1
          else
            echo "Coverage OK ($coverage%)"
          fi

  build:
    name: Build Changed Services
    needs: [test, coverage-check]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Build services
        run: |
          if [ -z "${{ needs.detect-changes.outputs.changed }}" ]; then
            echo "No changed services — building all modules."
            mvn -B clean package -DskipTests
          else
            for s in ${{ needs.detect-changes.outputs.changed }}; do
              echo "Building $s ..."
              cd $s
              mvn -B clean package -DskipTests
              cd ..
            done
          fi

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: built-jars
          path: '**/target/*.jar'
