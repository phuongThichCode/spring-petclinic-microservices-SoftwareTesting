name: CI Pipeline

on:
  push:
    branches: ["main", "develop", "feature/**"]
  pull_request:
    branches: ["main"]
jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Detect changed microservices
        id: changes
        run: |
          echo "CHANGED_SERVICES=$(git diff --name-only HEAD~1 HEAD | grep 'service' | cut -d'/' -f1 | sort -u | xargs)" >> $GITHUB_ENV
          echo "Changed services: $CHANGED_SERVICES"
      - name: Run tests
        if: env.CHANGED_SERVICES != ''
        run: |
          for s in $CHANGED_SERVICES; do
            echo "Testing $s"
            cd $s
            mvn clean test
            cd ..
          done
        else:
          mvn clean test
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: '**/target/surefire-reports/*.xml'

      - name: Upload JaCoCo coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: '**/target/site/jacoco/'
      - name: Check coverage threshold
        run: |
          COVERAGE=$(grep -h -oP '(?<=<counter type="INSTRUCTION" missed=")\d+" covered="\d+"' **/jacoco.xml | awk '{missed+=$1; covered+=$2} END {print covered*100/(missed+covered)}')
          echo "Coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "Coverage below 70%! Failing pipeline."
            exit 1
          fi
